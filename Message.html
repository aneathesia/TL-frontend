<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<button onclick="myFunction()"> send message  </button>
</body>
<script type="text/javascript" src="./config.js"></script>
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
<script>
    const domain = 'http://localhost:63342';
    var parorigin = encodeURIComponent('http://localhost:63342/TL-frontend/Message.html');
    var myPopup ;
    const pile  = [
        {
            "name": "J0",
            "y": 12504636.50283943,
            "x": 3800172.5915108467,
            "z": 0
        },
        {
            "name": "J1",
            "y": 12517783.671704473,
            "x": 3792223.1405691924,
            "z": 0
        },
        {
            "name": "J2",
            "y": 12533988.321700923,
            "x": 3788248.415098365,
            "z": 0
        },
        {
            "name": "J3",
            "y": 12544078.00943456,
            "x": 3784273.689627538,
            "z": 0
        },
        {
            "name": "J4",
            "y": 12554473.44528134,
            "x": 3777547.2311384454,
            "z": 0
        },
        {
            "name": "J5",
            "y": 12555390.689620761,
            "x": 3772043.7651019157,
            "z": 0
        },
        {
            "name": "J6",
            "y": 12545301.001887122,
            "x": 3763788.5660471204,
            "z": 0
        },
        {
            "name": "J7",
            "y": 12531542.336795798,
            "x": 3758896.5962368716,
            "z": 0
        },
        {
            "name": "J8",
            "y": 12511668.709441662,
            "x": 3755839.115105466,
            "z": 0
        },
        {
            "name": "J9",
            "y": 12503413.510386867,
            "x": 3753087.382087201,
            "z": 0
        },
        {
            "name": "J10",
            "y": 12504330.754726289,
            "x": 3746666.6717112493,
            "z": 0
        },
        {
            "name": "J11",
            "y": 12519923.908496456,
            "x": 3743914.938692984,
            "z": 0
        },
        {
            "name": "J12",
            "y": 12530625.092456376,
            "x": 3742080.450014141,
            "z": 0
        },
        {
            "name": "J13",
            "y": 12548969.97924481,
            "x": 3729239.0292622373,
            "z": 0
        },
        {
            "name": "J14",
            "y": 12557836.674525885,
            "x": 3728321.784922816,
            "z": 0
        }
    ]

    let point = [{x:2669000,y:12484080,z:0},{x:2669000,y:12484200,z:0}];
    let point2 = [{x:2669050,y:12484080,z:0},{x:2668920,y:12484210,z:0}];

    let templateCross = {
        "Attr":105,
        "AttrName":"0105:220KV",
        "AttrEx":0,
        "CrossPoint":point,
        "PointCount":2
    }


    let templateCross2 =  {
        "AttrName": "0105:220KV",
        "PointCount": 2,
        "CrossPoint": [
            {
                "y": 12504536.50283943,
                "x": 3800072.5915108467,
                "c": 1,
                "dc": 0,
                "dz": 0,
                "z": 0,
                "towerHigh": 15
            },
            {
                "y": 12504836.50283943,
                "x": 3800272.5915108467,
                "c": 1,
                "dc": 0,
                "dz": 0,
                "z": 0,
                "towerHigh": 15
            }
        ],
        "Attr": 105
    }
    let  CrossArray  = [];
    // CrossArray.push(templateCross);
    CrossArray.push(templateCross2);

    console.log(CrossArray);

    // const tlProjData={
    //     projectId : "9e1b72e0-20f8-11ec-af08-636b1966c8bc",
    //     projectName : '测试工程1',
    //     //maps:'test',
    //     cross:CrossArray,
    //     polyline: pile,
    //     projFiles:[],
    //     demid:"b5e7ab60-468b-11ec-8cdd-41cc8c05216b",
    //     fileExt:"tif"
    // }
    const tlProjData ={
        "projectId": "31803f50-5409-11ec-a516-21fb4ef81aec",
        "projectName": "排2",
        "polyline": [
            {
                "name": "J0",
                "y": 12511057.213215364,
                "x": 3779075.9717041613,
                "z": 0
            },
            {
                "name": "J1",
                "y": 12518370.206747903,
                "x": 3776623.313772553,
                "z": 0
            },
            {
                "name": "J2",
                "y": 12520969.065709595,
                "x": 3777292.137770048,
                "z": 0
            },
            {
                "name": "J3",
                "y": 12524204.382080419,
                "x": 3777088.608968746,
                "z": 0
            },
            {
                "name": "J4",
                "y": 12527261.863211827,
                "x": 3777088.608968746,
                "z": 0
            },
            {
                "name": "J5",
                "y": 12530625.092456376,
                "x": 3776782.8608556055,
                "z": 0
            }
        ],
        "demid": "dd3b4620-4d04-11ec-8762-39fa94726d25",
        "fileExt": "tif",
        "cross": [
            {
                "AttrName": "0105:220KV",
                "PointCount": 2,
                "CrossPoint": [
                    {
                        "x": 3777811.4242242146,
                        "y": 12517267.721763544,
                        "z": 0,
                        "towerHigh": 40
                    },
                    {
                        "x": 3776588.4317716537,
                        "y": 12517229.503249401,
                        "z": 0,
                        "towerHigh": 35
                    }
                ],
                "Attr": 105
            },
            {
                "AttrName": "0105:220KV",
                "PointCount": 2,
                "CrossPoint": [
                    {
                        "x": 3778652.231535355,
                        "y": 12521834.834203549,
                        "z": 0,
                        "towerHigh": 40
                    },
                    {
                        "x": 3775900.4985170923,
                        "y": 12521605.523118693,
                        "z": 0,
                        "towerHigh": 40
                    }
                ],
                "Attr": 105
            }
        ]
    }
    const tlmsg = {type:'Data',payload:tlProjData}

    //周期性的发送消息
    // setInterval(function(){
    //     var message = 'Hello!  The time is: ' + (new Date().getTime());
    //     console.log('blog.local:  sending message:  ' + message);
    //     //send the message and target URI
    //     myPopup.postMessage(message,domain);
    // },6000);
    function myFunction(){
        console.log('blog.local:  sending message:  ' ,tlmsg);
        //send the message and target URI
        myPopup = window.open('http://localhost:63342/TL-frontend/index.html?origin='+parorigin,'myWindow');
        //myPopup.postMessage(tlmsg,domain);
        //12731342.607406447,3550399.0716042966
        // var res = webMercator2lonlat(12731595,3550300);
        // console.log(res);
    }

    //监听消息反馈
    window.addEventListener('message',function(event) {
        if(event.origin !== domain) return;
        console.log('received response:  ',event.data);
        if(event.data.type =="ready") { myPopup.postMessage(tlmsg,domain);}
    },false);

    function webMercator2lonlat(x,y){
        var lonlat = [];
        var lon = x/20037508.34*180; //经度
        var lat = y/20037508.34*180; //纬度
        lat= 180/Math.PI*(2*Math.atan(Math.exp(lat*Math.PI/180))-Math.PI/2);
        lonlat[0] = lon;
        lonlat[1] = lat;
        return (lonlat);
    }


</script>
</html>