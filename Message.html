<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<button onclick="myFunction()"> send message  </button>
</body>
<script type="text/javascript" src="./config.js"></script>
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
<script>
    const domain = 'http://localhost:63342';
    var parorigin = encodeURIComponent('http://localhost:63342/TL-frontend/Message.html');
    var myPopup ;
    const pile  = [
        {
            "name": "J0",
            "y": 12504636.50283943,
            "x": 3800172.5915108467,
            "z": 0
        },
        {
            "name": "J1",
            "y": 12517783.671704473,
            "x": 3792223.1405691924,
            "z": 0
        },
        {
            "name": "J2",
            "y": 12533988.321700923,
            "x": 3788248.415098365,
            "z": 0
        },
        {
            "name": "J3",
            "y": 12544078.00943456,
            "x": 3784273.689627538,
            "z": 0
        },
        {
            "name": "J4",
            "y": 12554473.44528134,
            "x": 3777547.2311384454,
            "z": 0
        },
        {
            "name": "J5",
            "y": 12555390.689620761,
            "x": 3772043.7651019157,
            "z": 0
        },
        {
            "name": "J6",
            "y": 12545301.001887122,
            "x": 3763788.5660471204,
            "z": 0
        },
        {
            "name": "J7",
            "y": 12531542.336795798,
            "x": 3758896.5962368716,
            "z": 0
        },
        {
            "name": "J8",
            "y": 12511668.709441662,
            "x": 3755839.115105466,
            "z": 0
        },
        {
            "name": "J9",
            "y": 12503413.510386867,
            "x": 3753087.382087201,
            "z": 0
        },
        {
            "name": "J10",
            "y": 12504330.754726289,
            "x": 3746666.6717112493,
            "z": 0
        },
        {
            "name": "J11",
            "y": 12519923.908496456,
            "x": 3743914.938692984,
            "z": 0
        },
        {
            "name": "J12",
            "y": 12530625.092456376,
            "x": 3742080.450014141,
            "z": 0
        },
        {
            "name": "J13",
            "y": 12548969.97924481,
            "x": 3729239.0292622373,
            "z": 0
        },
        {
            "name": "J14",
            "y": 12557836.674525885,
            "x": 3728321.784922816,
            "z": 0
        }
    ]

    let point = [{
        "y": 12367130.463739606,
        "x": 3587820.4270534343,
        "c": 1,
        "dc": 0,
        "dz": 0,
        "z": 0,
        "towerHigh": 15
    },{
        "y": 12367140.463739606,
        "x": 3587810.4270534343,
        "c": 1,
        "dc": 0,
        "dz": 0,
        "z": 0,
        "towerHigh": 20
    }]


    let templateCross = {
        "Attr":105,
        "AttrName":"0105:220KV",
        "AttrEx":0,
        "CrossPoint": [
            {
            "y": 12367130.463739606,
            "x": 3587820.4270534343,
            "c": 1,
            "dc": 0,
            "dz": 0,
            "z": 0,
            "towerHigh": 15
            },
            {
            "y": 12367140.463739606,
            "x": 3587810.4270534343,
            "c": 1,
            "dc": 0,
            "dz": 0,
            "z": 0,
            "towerHigh": 20
        }
        ],
        "PointCount":2
    }


    let templateCross2 =  {
        "AttrName": "0105:220KV",
        "PointCount": 2,
        "CrossPoint": [
            {
                "y": 12361358.37553336,
                "x": 3594284.011485962,
                "c": 1,
                "dc": 0,
                "dz": 0,
                "z": 0,
                "towerHigh": 15
            },
            {
                "y": 12361258.37553336,
                "x": 3594284.011485962,
                "c": 1,
                "dc": 0,
                "dz": 0,
                "z": 0,
                "towerHigh": 15
            }
        ],
        "Attr": 105
    }
    let  CrossArray  = [];
    CrossArray.push(templateCross);
    CrossArray.push(templateCross2);

    console.log(CrossArray);

    // const tlProjData={
    //     projectId : "9e1b72e0-20f8-11ec-af08-636b1966c8bc",
    //     projectName : '测试工程1',
    //     //maps:'test',
    //     cross:CrossArray,
    //     polyline: pile,
    //     projFiles:[],
    //     demid:"b5e7ab60-468b-11ec-8cdd-41cc8c05216b",
    //     fileExt:"tif"
    // }
    // const tlProjData ={
    //     "projectId": "efc60f70-5ee1-11ec-9926-fd9b098d2480",
    //     "projectName": "排1",
    //     "polyline": [
    //         {
    //             "name": "J0",
    //             "y": 12504629.521983936,
    //             "x": 3775345.674165667,
    //             "z": 0
    //         },
    //         {
    //             "name": "J1",
    //             "y": 12510820.921275029,
    //             "x": 3775880.733363663,
    //             "z": 0
    //         },
    //         {
    //             "name": "J2",
    //             "y": 12517547.379764115,
    //             "x": 3776262.918505088,
    //             "z": 0
    //         },
    //         {
    //             "name": "J3",
    //             "y": 12524579.58636634,
    //             "x": 3776339.355533373,
    //             "z": 0
    //         },
    //         {
    //             "name": "J4",
    //             "y": 12533828.466788836,
    //             "x": 3776339.355533373,
    //             "z": 0
    //         },
    //         {
    //             "name": "J5",
    //             "y": 12538261.814429369,
    //             "x": 3777027.2887879387,
    //             "z": 0
    //         },
    //         {
    //             "name": "J6",
    //             "y": 12543000.910183044,
    //             "x": 3777485.9109576494,
    //             "z": 0
    //         },
    //         {
    //             "name": "J7",
    //             "y": 12545523.332116451,
    //             "x": 3775804.2963353777,
    //             "z": 0
    //         },
    //         {
    //             "name": "J8",
    //             "y": 12551561.857350972,
    //             "x": 3776645.1036465135,
    //             "z": 0
    //         },
    //         {
    //             "name": "J9",
    //             "y": 12554848.64956723,
    //             "x": 3777485.9109576494,
    //             "z": 0
    //         },
    //         {
    //             "name": "J10",
    //             "y": 12556606.701217787,
    //             "x": 3779702.5847779163,
    //             "z": 0
    //         },
    //         {
    //             "name": "J11",
    //             "y": 12561498.671028031,
    //             "x": 3780008.332891057,
    //             "z": 0
    //         }
    //     ],
    //     "demid": "3f4f7ff0-5ee1-11ec-9bb2-4d4d7d1670a0",
    //     "fileExt": "tif",
    //     "cross": []
    // }
    const tlProjData1 ={
        "projectId": "220221",
        "projectName": "Mon",
        "maps":"move",
        "polyline": [
            {
                "name": "J2",
                "y": 12351680.184025994,
                "x": 3593008.1449768282,
                "z": 0
            },
            {
                "name": "J3",
                "y": 12361158.37553336,
                "x": 3594384.011485962,
                "z": 0
            },
            {
                "name": "J4",
                "y": 12367120.463739606,
                "x": 3587810.4270534343,
                "z": 0
            },
            {
                "name": "J5",
                "y": 12374305.544398414,
                "x": 3590867.9081848427,
                "z": 0
            },
            {
                "name": "J6",
                "y": 12379503.262321807,
                "x": 3582918.4572431813,
                "z": 0
            },
            {
                "name": "J7",
                "y": 12388369.957602892,
                "x": 3585364.442148308,
                "z": 0
            },
            {
                "name": "J8",
                "y": 12391427.4387343,
                "x": 3577414.9912066464,
                "z": 0
            },
            {
                "name": "J9",
                "y": 12397848.149110258,
                "x": 3579555.227998632,
                "z": 0
            },
            {
                "name": "J10",
                "y": 12401517.126467947,
                "x": 3572828.7695095344,
                "z": 0
            }
        ],
        "demid": "6750eef0-5809-11ec-a637-213124b7c716",
        "fileExt": "tif",
        "cross": CrossArray
    }
    const tlProjData ={
        "projectId": "220221",
        "projectName": "Mon",
        "maps":"move",
        "polyline": [],
        "demid": "6750eef0-5809-11ec-a637-213124b7c716",
        "fileExt": "tif",
        "cross": []
    }
    const tlmsg = {type:'Data',payload:tlProjData1}

    //周期性的发送消息
    // setInterval(function(){
    //     var message = 'Hello!  The time is: ' + (new Date().getTime());
    //     console.log('blog.local:  sending message:  ' + message);
    //     //send the message and target URI
    //     myPopup.postMessage(message,domain);
    // },6000);
    function myFunction(){
        console.log('blog.local:  sending message:  ' ,tlmsg);
        //send the message and target URI
        myPopup = window.open('http://localhost:63342/TL-frontend/index.html?origin='+parorigin,'myWindow');
        //myPopup.postMessage(tlmsg,domain);
        //12731342.607406447,3550399.0716042966
        // var res = webMercator2lonlat(12731595,3550300);
        // console.log(res);
    }

    //监听消息反馈
    window.addEventListener('message',function(event) {
        if(event.origin !== domain) return;
        console.log('received response:  ',event.data);
        if(event.data.type =="ready") { myPopup.postMessage(tlmsg,domain);}
    },false);

    function webMercator2lonlat(x,y){
        var lonlat = [];
        var lon = x/20037508.34*180; //经度
        var lat = y/20037508.34*180; //纬度
        lat= 180/Math.PI*(2*Math.atan(Math.exp(lat*Math.PI/180))-Math.PI/2);
        lonlat[0] = lon;
        lonlat[1] = lat;
        return (lonlat);
    }


</script>
</html>